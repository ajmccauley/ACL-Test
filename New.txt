Comment
*******************************************************************************
**     Script Name:    JDE Row Security Analysis
**     Description:    Get a list of all Active JDE Users for a specific country
**     Created By:     Christina Edwards, Mary Kay Inc.
**     Created On:     09/01/2016
**     Modified By:  
**     Modified on:
**     Comment:  
*******************************************************************************
END

COMMENT Basic parameters initialization.
SET SAFETY OFF
SET SYS 39 1
SET DATE "YYYYMMDD"
CLOSE PRI SEC
SET FOLDER /Temp


COMMENT Compare F00950 to F95921 to get list of users and associated groups. 
COMMENT *NOTE* If a role exists in the F00950 table but does not exist in the F95921 table then it is an orphaned role and is not included
OPEN F00950
OPEN F95921 SECONDARY
JOIN PKEY FSUSER FIELDS FSA FSADDC FSATN1 FSATN2 FSATN3 FSCHNG FSDLT FSDTAI FSEXITID FSFMNM FSFRDV FSFUNO FSICPY FSINSL FSIOK FSIUPT FSJOBN FSMUSE FSOBID FSOBNM FSOWDI FSPID FSPTH FSRUN FSSETY FSSY FSTABID FSTEXTID FSTHDV FSUPMJ FSUPMT FSUSER FSVWYN SKEY RLFRROLE WITH RLTOROLE MANY TO "R_F00950_F95921" PRESORT SECSORT ISOLOCALE root


COMMENT Compare list of users/roles to the list of roles that exist.
OPEN R_F00950_F95921
OPEN F0092 SECONDARY
JOIN PKEY RLTOROLE FIELDS RLTOROLE FSVWYN FSUSER FSUPMT FSUPMJ FSTHDV FSTEXTID FSTABID FSSY FSSETY FSRUN FSPTH FSPID FSOWDI FSOBNM FSOBID FSMUSE FSJOBN FSIUPT FSIOK FSINSL FSICPY FSFUNO FSFRDV FSFMNM FSEXITID FSDTAI FSDLT FSCHNG FSATN3 FSATN2 FSATN1 FSADDC FSA SKEY ULUSER TO "T_All_Users" PRESORT SECSORT ISOLOCALE root

COMMENT Compare list of existing roles/users to active users
COMMENT *NOTE* A user is in active if, in the F98OWSEC table, their status is set to 'TERMINATED'
OPEN T_All_Users
OPEN F98OWSEC SECONDARY
JOIN PKEY RLTOROLE FIELDS RLTOROLE FSVWYN FSUSER FSUPMT FSUPMJ FSTHDV FSTEXTID FSTABID FSSY FSSETY FSRUN FSPTH FSPID FSOWDI FSOBNM FSOBID FSMUSE FSJOBN FSIUPT FSIOK FSINSL FSICPY FSFUNO FSFRDV FSFMNM FSEXITID FSDTAI FSDLT FSCHNG FSATN3 FSATN2 FSATN1 FSADDC FSA SKEY SCUSER WITH SCEUSER SCSECUSR TO "T_All_users_and_roles" PRESORT SECSORT ISOLOCALE root

OPEN "T_All_users_and_roles" 
EXTRACT RECORD IF scsecusr <> "TERMINATED" TO "R_All_Active_Users_and_Roles"

COMMENT Get all users with row security explicit and implicit access to functions.

OPEN "R_All_Active_Users_and_Roles"
EXTRACT RECORD IF FSSETY = "1" TO "T_All_Active_Users_and_Roles_1"
OPEN R_All_Active_Users_and_Roles
EXTRACT RECORD IF FSSETY = "4" AND FSOBNM = "*ALL" TO "T_ALL_ACTIVE_USERS_AND_ROLES_4" 


OPEN T_ALL_ACTIVE_USERS_AND_ROLES_1
OPEN T_ALL_ACTIVE_USERS_AND_ROLES_4 SECONDARY
JOIN PKEY RLTOROLE FIELDS FSA FSADDC FSATN1 FSATN2 FSATN3 FSCHNG FSDLT FSDTAI FSEXITID FSFUNO FSICPY FSINSL FSIOK FSIUPT FSJOBN FSMUSE FSOBID FSOBNM FSOWDI FSPID FSPTH FSRUN FSSETY FSSY FSTABID FSTEXTID FSUPMJ FSUPMT FSUSER FSVWYN RLTOROLE SCEUSER SKEY RLTOROLE WITH FSFRDV FSTHDV MANY TO "T_AllActiveUserAndRoles1_4" PRESORT SECSORT ISOLOCALE root

OPEN T_ALL_ACTIVE_USERS_AND_ROLES_1
OPEN T_ALL_ACTIVE_USERS_AND_ROLES_4 SECONDARY
JOIN PKEY RLTOROLE FSOBNM FIELDS FSA FSADDC FSATN1 FSATN2 FSATN3 FSCHNG FSDLT FSDTAI FSEXITID  FSFUNO FSICPY FSINSL FSIOK FSIUPT FSJOBN FSMUSE FSOBID FSOBNM FSOWDI FSPID FSPTH FSRUN FSSETY FSSY FSTABID FSTEXTID FSUPMJ FSUPMT FSUSER FSVWYN RLTOROLE SCEUSER FSFRDV FSTHDV SKEY RLTOROLE FSOBNM  UNMATCHED TO "T_AllActiveUserAndRoles1_4" APPEND PRESORT SECSORT ISOLOCALE root

COMMENT Determine if a user has access to the specified cost centers (update the match as needed)
OPEN "T_AllActiveUserAndRoles1_4"
DEFINE FIELD c_FSFRDVAllTrim COMPUTED ALLTRIM(FSFRDV)
CLOSE 

OPEN T_Cost_Centers
DEFINE FIELD c_ListItemAllTrim COMPUTED 
  WIDTH 30 
  ALLTRIM( List_Item)
CLOSE

OPEN T_AllActiveUserAndRoles1_4
OPEN T_Cost_Centers SECONDARY
JOIN PKEY c_FSFRDVALLTRIM FIELDS FSA FSADDC FSATN1 FSATN2 FSATN3 FSCHNG FSDLT FSDTAI FSEXITID FSFRDV FSFUNO FSICPY FSINSL FSIOK FSIUPT FSJOBN FSMUSE FSOBID FSOBNM FSOWDI FSPID FSPTH FSRUN FSSETY FSSY FSTABID FSTEXTID FSTHDV FSUPMJ FSUPMT FSUSER FSVWYN RLTOROLE SCEUSER c_FSFRDVALLTRIM SKEY c_ListItemAllTrim TO "R_ALLActiveUserAndRoles1_4" OPEN PRESORT SECSORT ISOLOCALE root

EXTRACT RECORD IF NOT ISBLANK(FSOBNM) TO "R_RowSec_ExplicitDEAccess" OPEN

OPEN "R_AllActiveUserAndRoles1_4"
EXTRACT RECORD IF ISBLANK(FSFRDV) AND NOT ISBLANK(FSOBNM) TO "R_RowSec_ImpliedDEAccess" OPEN

OPEN R_RowSec_ExplicitDEAccess
EXTRACT RECORD TO "R_RowSec_Exp_and_IMP"

OPEN R_RowSec_ImpliedDEAccess
EXTRACT RECORD TO "R_RowSec_Exp_and_IMP" OPEN APPEND

SET FOLDER /Outputs
OPEN R_All_Active_Users_and_Roles
OPEN R_RowSec_Exp_and_IMP SECONDARY
JOIN PKEY RLTOROLE FIELDS SCEUSER RLTOROLE FSVWYN FSUSER FSUPMT FSUPMJ FSTHDV FSTEXTID FSTABID FSSY FSSETY FSRUN FSPTH FSPID FSOWDI FSOBNM FSOBID FSMUSE FSJOBN FSIUPT FSIOK FSINSL FSICPY FSFUNO FSFRDV FSFMNM FSEXITID FSDTAI FSDLT FSCHNG FSATN3 FSATN2 FSATN1 FSADDC FSA SKEY RLTOROLE WITH FSFRDV RLTOROLE FSTHDV TO "AllActiveUsersWithRowSec" OPEN PRESORT SECSORT ISOLOCALE root
